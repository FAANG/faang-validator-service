<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/static/style.css" rel="stylesheet" />
  </head>
  <body>

    <p class="controls">
      <input id="text" type="search" placeholder="Input text" />
      <button id="send" disabled>Send</button>
      <span id="status"></span>
    </p>

    <div id="log" aria-live="polite"></div>

    <script>
      const log = document.getElementById("log");
      const sendBtn = document.getElementById("send");
      const statusEl = document.getElementById("status");
      const textInput = document.getElementById("text");

      function add(text, mine=false) {
        const d = document.createElement("div");
        d.className = "b" + (mine ? " me" : "");
        d.textContent = text;
        log.appendChild(d);
        log.scrollTop = log.scrollHeight;
      }

      const wsScheme = location.protocol === "https:" ? "wss" : "ws";
      const ws = new WebSocket(`${wsScheme}://${location.host}/ws`);
      ws.onopen   = () => { add("WS connected"); sendBtn.disabled = false; };
      ws.onmessage= (e) => add(e.data);
      ws.onclose  = () => { add("WS disconnected"); sendBtn.disabled = true; };

      textInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendBtn.click();
      });

      sendBtn.onclick = async () => {
        const text = textInput.value.trim();
        if (!text) { add("Input text"); return; }

        const body = new URLSearchParams({
          text,
          filename: "manual_input.txt"
        });

        add("You: " + (text.length > 60 ? text.slice(0,60)+"…" : text), true);
        try {
          statusEl.textContent = "Sending…";
          const r = await fetch("/upload", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
            body
          });
          statusEl.textContent = "";
          add("HTTP /upload → " + r.status);
          if (r.ok) textInput.value = "";
        } catch (err) {
          statusEl.textContent = "";
          add("HTTP error: " + err);
        }
      };
    </script>
  </body>
</html>
